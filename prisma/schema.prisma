generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Institution {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  type        String?
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  cases       Case[]
  users       User[]

  @@index([name])
}

model User {
  id                   Int                       @id @default(autoincrement())
  username             String                    @unique
  password             String
  email                String                    @unique
  fullName             String
  role                 String
  institution          String?
  institutionId        Int?
  active               Boolean                   @default(true)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  createdCases         Case[]                    @relation("CreatedCases")
  finalReviewedCases   Case[]                    @relation("FinalReviewedCases")
  institutionResponses Case[]                    @relation("InstitutionResponses")
  legalReviewedCases   Case[]                    @relation("LegalReviewedCases")
  uploadedFiles        CaseFile[]
  caseActions          CaseHistory[]
  conversations        ConversationParticipant[]
  sentMessages         Message[]
  readMessages         MessageRead[]
  sessions             Session[]
  createdTasks         Task[]                    @relation("CreatedTasks")
  assignedTasks        Task[]                    @relation("AssignedTasks")
  taskComments         TaskComment[]
  institutionRelation  Institution?              @relation(fields: [institutionId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([institutionId])
}

model Session {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Case {
  id                      Int           @id @default(autoincrement())
  caseNumber              String        @unique
  title                   String
  description             String
  platform                String
  priority                String
  status                  String        @default("IDP_FORM")
  tags                    String        @default("[]")
  geographicScope         String
  sourceType              String
  sourceUrl               String?
  newsHeadline            String?
  newspaperAuthor         String?
  newsSummary             String?
  ministryInfo            String?
  relatedMinistry         String?
  submittedTo             String?
  submittingUnit          String?
  preparedBy              String?
  disinformationType      String?
  expertEvaluation        String?
  legalEvaluation         String?
  recommendation          String?
  idpAssessment           String?
  idpNotes                String?
  legalAssessment         String?
  legalNotes              String?
  legalApproved           Boolean?
  legalReviewerId         Int?
  legalReviewDate         DateTime?
  finalNotes              String?
  finalApproval           Boolean?
  finalReviewerId         Int?
  finalReviewDate         DateTime?
  internalReport          String?
  externalReport          String?
  targetMinistry          String?
  targetInstitutionId     Int?
  reportGeneratedDate     DateTime?
  institutionResponse     String?
  institutionResponderId  Int?
  institutionResponseDate DateTime?
  correctiveInfo          String?
  createdById             Int
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  creator                 User          @relation("CreatedCases", fields: [createdById], references: [id], onUpdate: NoAction)
  legalReviewer           User?         @relation("LegalReviewedCases", fields: [legalReviewerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  finalReviewer           User?         @relation("FinalReviewedCases", fields: [finalReviewerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  institutionResponder    User?         @relation("InstitutionResponses", fields: [institutionResponderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  targetInstitution       Institution?  @relation(fields: [targetInstitutionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  files                   CaseFile[]
  history                 CaseHistory[]
  tasks                   Task[]

  @@index([targetInstitutionId])
}

model CaseFile {
  id           Int      @id @default(autoincrement())
  caseId       Int
  fileName     String
  filePath     String
  fileData     Bytes?
  fileType     String
  fileSize     Int
  uploadedById Int
  uploadedAt   DateTime @default(now())
  case         Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  uploader     User     @relation(fields: [uploadedById], references: [id], onUpdate: NoAction, onDelete: NoAction)
}

model CaseHistory {
  id        Int      @id @default(autoincrement())
  caseId    Int
  userId    Int
  action    String
  oldStatus String
  newStatus String
  notes     String?
  createdAt DateTime @default(now())
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onUpdate: NoAction, onDelete: NoAction)
}

model Task {
  id           Int           @id @default(autoincrement())
  title        String
  description  String
  priority     String        @default("MEDIUM")
  status       String        @default("PENDING")
  assignedToId Int
  assignedById Int
  caseId       Int?
  dueDate      DateTime?
  completedAt  DateTime?
  feedback     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  assignedBy   User          @relation("CreatedTasks", fields: [assignedById], references: [id], onUpdate: NoAction, onDelete: NoAction)
  assignedTo   User          @relation("AssignedTasks", fields: [assignedToId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  case         Case?         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  comments     TaskComment[]

  @@index([assignedToId])
  @@index([assignedById])
  @@index([caseId])
}

model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int
  userId    Int
  comment   String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  @@index([taskId])
  @@index([userId])
}

model Conversation {
  id              Int                       @id @default(autoincrement())
  title           String?
  isGroup         Boolean                   @default(false)
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  lastMessageAt   DateTime                  @default(now())
  lastMessageText String?
  participants    ConversationParticipant[]
  messages        Message[]
}

model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  conversationId Int
  userId         Int
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime     @default(now())
  isActive       Boolean      @default(true)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             Int           @id @default(autoincrement())
  conversationId Int
  senderId       Int
  content        String
  isEdited       Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User          @relation(fields: [senderId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  readBy         MessageRead[]

  @@index([conversationId])
  @@index([senderId])
}

model MessageRead {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onUpdate: NoAction, onDelete: NoAction)

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
}
